-- ===============================================
-- DAX Measures Library (paste into a Measures table)
-- ===============================================

-- Customers & Activity
Total Customers = DISTINCTCOUNT(Customers[Customer ID])

Active Customers (90d) =
VAR Cutoff = MAX('DimDate'[Date]) - 90
RETURN
    CALCULATE(
        DISTINCTCOUNT(Customers[Customer ID]),
        Customers[Last Transaction Date] >= Cutoff
    )

Inactive Customers (180d) =
VAR Cutoff = MAX('DimDate'[Date]) - 180
RETURN
    CALCULATE(
        DISTINCTCOUNT(Customers[Customer ID]),
        OR( ISBLANK(Customers[Last Transaction Date]), Customers[Last Transaction Date] < Cutoff )
    )

Churn Risk % = DIVIDE([Inactive Customers (180d)], [Total Customers])

New Accounts =
CALCULATE(
    COUNTROWS(DimAccount),
    USERELATIONSHIP('DimDate'[Date], DimAccount[Date Of Account Opening])
)

-- Deposits
Total Deposits = SUM(FactAccountsSnapshot[Account Balance])

-- Loans
Total Loans = SUM(FactLoans[Loan Amount])

Loan-to-Deposit Ratio = DIVIDE([Total Loans], [Total Deposits])

Weighted Avg Interest Rate =
DIVIDE(
    SUMX(FactLoans, FactLoans[Loan Amount] * FactLoans[Interest Rate]),
    [Total Loans]
)

Loan Applications = COUNTROWS(FactLoans)

Loan Approvals =
CALCULATE(
    COUNTROWS(FactLoans),
    FactLoans[Loan Status] = "Approved"
)

Approval Rate % = DIVIDE([Loan Approvals], [Loan Applications])

-- Transactions
Txn Count = COUNTROWS(FactTransactions)
Txn Amount = SUM(FactTransactions[Transaction Amount])

Txn Amount (MTD) =
CALCULATE([Txn Amount], DATESMTD('DimDate'[Date]))

Txn Amount (YTD) =
CALCULATE([Txn Amount], DATESYTD('DimDate'[Date]))

-- Cards
Total Credit Limit = SUM(FactCards[Credit Limit])
Total Card Balance = SUM(FactCards[Credit Card Balance])
Card Utilization % = DIVIDE([Total Card Balance], [Total Credit Limit])

Overdue Minimum Payments =
CALCULATE(
    COUNTROWS(FactCards),
    FactCards[Payment Due Date] < MAX('DimDate'[Date])
        && FactCards[Minimum Payment Due] > 0
)

-- CX & Ops
Complaints =
CALCULATE(COUNTROWS(FactFeedback), FactFeedback[Feedback Type] = "Complaint")

Praise =
CALCULATE(COUNTROWS(FactFeedback), FactFeedback[Feedback Type] = "Praise")

Suggestions =
CALCULATE(COUNTROWS(FactFeedback), FactFeedback[Feedback Type] = "Suggestion")

Total Feedback = COUNTROWS(FactFeedback)

Complaint Rate % = DIVIDE([Complaints], [Total Feedback])

NPS Proxy % =
DIVIDE([Praise], [Total Feedback]) - DIVIDE([Complaints], [Total Feedback])

Avg Time to Resolution (days) =
AVERAGEX(
    FILTER(FactFeedback, NOT ISBLANK(FactFeedback[Resolution Date])),
    DATEDIFF(FactFeedback[Feedback Date], FactFeedback[Resolution Date], DAY)
)

-- Risk
Anomaly Count = CALCULATE(COUNTROWS(FactRisk), FactRisk[Anomaly] = 1)
Anomaly Rate % = DIVIDE([Anomaly Count], [Total Customers])

-- RFM (90d window)
Recency (days) =
VAR lastTxn =
    CALCULATE(
        MAX(FactTransactions[Transaction Date]),
        ALLEXCEPT(Customers, Customers[Customer ID])
    )
RETURN DATEDIFF(lastTxn, MAX('DimDate'[Date]), DAY)

Frequency (90d) =
VAR Cutoff = MAX('DimDate'[Date]) - 90
RETURN CALCULATE(COUNTROWS(FactTransactions), FactTransactions[Transaction Date] >= Cutoff)

Monetary (90d) =
VAR Cutoff = MAX('DimDate'[Date]) - 90
RETURN CALCULATE(SUM(FactTransactions[Transaction Amount]), FactTransactions[Transaction Date] >= Cutoff)